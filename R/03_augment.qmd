---
title: "Augment data"
format:
  html:
    embed-resources: true
editor: visual
---

1.  Load data and relevant libraries

```{r}
#| message: false
library("tidyverse")
library("dplyr")

```

```{r}
data_dir <- "../data"
data_file <- "/02_data_load.tsv.gz" 
aug_input <- read_tsv(str_c(data_dir, data_file))

```

2.  Normalizing the data by log transformation. Adding a small value before log transforming data, to ensure that zeros do not appear.

```{r}
df_aug <- aug_input |> 
  mutate(across(starts_with("reads") | starts_with("RPM") | starts_with("RPKM"),~ log2(.+0.0001)))
```


3.  Calculating mean of the three groups, and adding the columns to the file

```{r}
data_augmented <- df_aug |> 
  mutate(
    mean_reads_control = rowMeans(across(starts_with("reads_control")),
                          na.rm = TRUE),
    mean_reads_tau = rowMeans(across(starts_with("reads_tau")),
                          na.rm = TRUE),
    mean_rpm_control = rowMeans(across(starts_with("RPM_control")),
                        na.rm = TRUE),
    mean_rpm_tau = rowMeans(across(starts_with("RPM_tau")),
                        na.rm = TRUE),
    mean_rpkm_control = rowMeans(across(starts_with("RPKM_control")),
                         na.rm = TRUE),
    mean_rpkm_tau = rowMeans(across(starts_with("RPKM_tau")),
                         na.rm = TRUE))
```

4.    Calculate the variance
```{r}
data_augmented <- data_augmented |>
  rowwise() |> 
  mutate(
    var_reads = var(c_across(starts_with("reads")), na.rm = TRUE),
    var_rpm = var(c_across(starts_with("RPM")), na.rm = TRUE),
    var_rpmkm = var(c_across(starts_with("RPKM")), na.rm = TRUE)
  ) |> 
  ungroup()
```

Create a separate data set for our statistics and add a fold change variable

```{r}
stats_df <- data_augmented |> 
  select(
    gene_ensembl,
    starts_with("mean"),
    starts_with("var")
  ) |> 
  mutate(
    fold_change_reads = mean_reads_tau / mean_reads_control,
    fold_change_rpm = mean_rpm_tau / mean_rpm_control,
    fold_change_rpkm = mean_rpkm_tau / mean_rpkm_control
  )
```

```{r}
data_augmented <- data_augmented |> 
  select(
    -starts_with("var"),
    -starts_with("mean")
  )
```


5.  Our dataset is a wide dataset however, It might be of interest having our df in a long format

```{r}
data_long_augmented <- data_augmented |> 
  pivot_longer(
    cols = contains(c("control", "tau")), 
    names_to = "experiment", 
    values_to = "gene_expression"
  )
```

The data is now normalized, mean is calcualted for each category and the data is in long format.

6.  Data is saved in file:
3 datasets will be saved:
-   A wide dataset with all experiments
-   a long dataset with all experiments
-   a dataset containing relevant statistics that might be useful in filtering the genes with that have more expression differences.

```{r}
data_long_augmented |> 
  write_tsv(file = "../data/03_data_load.tsv.gz")

```

```{r}
data_augmented |>
  write_tsv(file = "../data/03_data_load_wide.tsv.gz")
```

```{r}
stats_df |> 
  write_tsv(file = "../data/03_data_stats_load.tsv.gz")
```

